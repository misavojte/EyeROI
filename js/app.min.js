var aoiSegments,aoiCategories,participants,stimulus,popup;function initDataObjects(){aoiSegments={startTime:[],endTime:[],isFixation:[],AOIid:[]},aoiCategories={names:[],colors:["#66c5cc","#f6cf71","#f89c74","#dcb0f2","#87c55f","#9eb9f3","#fe88b1","#c9db74","#8be0a4","#b497e7","#d3b484","#b3b3b3"]},participants={sessionDuration:[],maxDuration:[],names:[],highestAOISegmentId:[]},stimulus={currentlySelected:0,names:[]}}function startDemo(){fetch("demodata.json").then(e=>(printDataCanvas(),e.json())).then(e=>{participants=e[0],aoiCategories=e[1],stimulus=e[2],aoiSegments=e[3],printSequenceChart()})}function onFileUploadChange(e){const t=e.target.files[0];if(t){const e=t.name.split(".").pop();if(initDataObjects(),printDataCanvas(),"txt"==e){let e=new FileReader;e.onload=function(){preprocess_TXT(e.result)},e.readAsText(t)}}}function preprocess_TXT(e){let t=e.split("\r\n");t[0].includes("RecordingTime [ms]")&&t[0].includes("AOI Name Right")&&(t.pop(),process_SMI_Raw_Static(t.map(e=>e.split("\t"))))}function process_SMI_Raw_Static(e){let t=!0,n=0,s=0,i=0,a=-1,l=e.length-1;for(var o=1;o<l;o++)!0===t&&c(o),e[o][1]!==i&&r(o),e[o][2]!==e[o+1][2]||e[o][1]!==e[o+1][1]?d(o):e[o][5]!==e[o+1][5]&&u(o);function c(i){n=e[i][0],s=0,t=!1}function r(t){const n=stimulus.names.indexOf(e[o][1]);-1===n?(participants.sessionDuration.push([]),participants.highestAOISegmentId.push([]),aoiCategories.names.push([]),aoiSegments.startTime.push([]),aoiSegments.endTime.push([]),aoiSegments.AOIid.push([]),stimulus.names.push(e[o][1]),stimulus.currentlySelected=stimulus.names.length-1,i=e[o][1],a=-1):(i=e[o][1],a=aoiSegments.AOIid[n].length-1,stimulus.currentlySelected=n)}function d(s){u(s),t=!0,participants.highestAOISegmentId[stimulus.currentlySelected].push(a),participants.names.includes(e[s][2])||participants.names.push(e[s][2]),participants.sessionDuration[stimulus.currentlySelected].push(e[s][0]-n)}function u(t){a++;const i=e[t][0]-n;aoiCategories.names[stimulus.currentlySelected].includes(e[t][5])||aoiCategories.names[stimulus.currentlySelected].push(e[t][5]),aoiSegments.AOIid[stimulus.currentlySelected].push(aoiCategories.names[stimulus.currentlySelected].indexOf(e[t][5])),aoiSegments.endTime[stimulus.currentlySelected].push(i),aoiSegments.startTime[stimulus.currentlySelected].push(s),s=i}t&&c(l),d(l);for(o=0;o<stimulus.names.length;o++)participants.maxDuration[o]=Math.max(...participants.sessionDuration[o]);printSequenceChart()}function printSequenceChart(){let e='<h3 class="cardtitle">Sequence chart (Scarf plot)</h3>';e+='<div class="btnholder">'+('<select onchange="handleStimulusChange(this)" id="SPstimulus">'+stimulus.names.map((e,t)=>{let n="";return stimulus.currentlySelected===t&&(n="selected"),'<option value="'+t+'" '+n+">"+e+"</option>"}).join("")+"</select>")+'<div class="btn3 torelative"><div class="btn3-absolute">Absolute timeline</div><div class="btn3-relative">Relative timeline</div></div><svg id="zoomInScarf" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="btn4" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z"/><path d="M10.344 11.742c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1 6.538 6.538 0 0 1-1.398 1.4z"/><path fill-rule="evenodd" d="M6.5 3a.5.5 0 0 1 .5.5V6h2.5a.5.5 0 0 1 0 1H7v2.5a.5.5 0 0 1-1 0V7H3.5a.5.5 0 0 1 0-1H6V3.5a.5.5 0 0 1 .5-.5z"/></svg><svg id="zoomOutScarf" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="btn4 deactivated" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z"/><path d="M10.344 11.742c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1 6.538 6.538 0 0 1-1.398 1.4z"/><path fill-rule="evenodd" d="M3 6.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"/></svg><svg onclick="showDownloadScarfPlotScreen()" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="btn4" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg></div>',e+='<div class="chartwrap">',e+=paintAbsoluteBars(),e+="</div>",document.getElementById("chartsec").innerHTML=e,document.body.onmouseover=handler,document.getElementsByClassName("torelative")[0].onclick=handleRelative,document.getElementById("zoomInScarf").onclick=zoomScarf,document.getElementById("zoomOutScarf").onclick=zoomScarf}function paintAbsoluteBars(){let e=-30,t=30*participants.names.length,n="",s=participants.maxDuration[stimulus.currentlySelected],i="<div class='charea-holder'><svg xmlns='http://www.w3.org/2000/svg' id='charea' style='overflow:visible' width='100%' height='"+(t+20)+"'>";i+="<animate id='chareaAni' attributeName='width' from='100%' to='100%' dur='0.3s' fill='freeze'/>",i+="<g><line class='gr y-gr' stroke='#cbcbcb' stroke-width='1'  x1='0' x2='100%' y1='"+t+"' y2='"+t+"'></line>></g>";const a=getSteps(s);s=a.step*a.numberOfSteps,i+="<g id='chxcomponent'>"+getXComponentOfScarf(t,a)+"</g>";for(var l=0;l<participants.names.length;l++){if(segStart=participants.highestAOISegmentId[stimulus.currentlySelected][l-1]+1,0===l&&(segStart=0),segEnd=participants.highestAOISegmentId[stimulus.currentlySelected][l],e+=30,segEnd){i+="<svg class='barwrap' y='"+e+"' data-pid='"+l+"' width='"+participants.sessionDuration[stimulus.currentlySelected][l]/s*100+"%'>",i+="<animate attributeName='width' from='0%' to='"+participants.sessionDuration[stimulus.currentlySelected][l]/s*100+"%' dur='0.3s' fill='freeze'/>";for(var o=segStart;o<segEnd+1;o++){let e=aoiSegments.startTime[stimulus.currentlySelected][o];i+="<rect height='20' data-sid='"+o+"' fill='"+aoiCategories.colors[aoiSegments.AOIid[stimulus.currentlySelected][o]]+"' class='a"+aoiSegments.AOIid[stimulus.currentlySelected][o]+"' x='"+e/participants.sessionDuration[stimulus.currentlySelected][l]*100+"%' width='"+(aoiSegments.endTime[stimulus.currentlySelected][o]-e)/participants.sessionDuration[stimulus.currentlySelected][l]*100+"%'></rect>"}i+="</svg>"}else console.log("Participant "+participants.names[l]+" has no AOI segments in stimulus "+stimulus.names[stimulus.currentlySelected]);n+="<div>"+participants.names[l]+"</div>"}let c="<div id='chylabs'>";c+=n,i=(c+="</div>")+(i+="</svg></div>"),i+="<div id='chxlab'>Elapsed time [ms]</div>",i+="<div id='chlegend'>";for(o=0;o<aoiCategories.names[stimulus.currentlySelected].length;o++)i+="<div data-aoi='"+o+"' class='legendItem a"+o+"'><div class='legendRect' style='background:"+aoiCategories.colors[o]+"'></div><div>"+aoiCategories.names[stimulus.currentlySelected][o]+"</div></div>";return i+="</div>"}function handler(e){const t=e.target.closest("#charea rect"),n=e.target.closest(".legendItem"),s=document.querySelector("#charea style");function i(n){const s=t.getBoundingClientRect(),i=aoiSegments.startTime[stimulus.currentlySelected][n];popup.innerHTML="<span>Participant: "+participants.names[participants.highestAOISegmentId[stimulus.currentlySelected].findIndex(e=>e>=n)]+"</span><span>AOI: "+aoiCategories.names[stimulus.currentlySelected][aoiSegments.AOIid[stimulus.currentlySelected][n]]+"</span><span>Start: "+i.toFixed(1)+" ms</span><span>End: "+aoiSegments.endTime[stimulus.currentlySelected][n].toFixed(1)+" ms</span><span>Duration: "+(aoiSegments.endTime[stimulus.currentlySelected][n]-i).toFixed(1)+" ms</span>",popup.style.top=window.scrollY+s.bottom+"px";let a=e.pageX;e.pageX+155>window.scrollX+document.body.clientWidth&&(a=window.scrollX+document.body.clientWidth-155),popup.style.left=a+"px"}e.target.closest("#datatooltip")||(t?void 0!==popup?(popup.style.display="none",i(t.dataset.sid),popup.style.display=""):((popup=document.createElement("div")).classList="popup",popup.id="datatooltip",i(t.dataset.sid),document.body.appendChild(popup)):(s&&s.remove(),n&&function(){const e=n.dataset.aoi;let t=document.createElement("style");t.innerHTML="rect{opacity:0.2}rect.a"+e+"{opacity:1;stroke:#0000007d}",document.getElementById("charea").append(t)}(),popup&&(popup.style.display="none")))}function getPrettyBreakStep(e,t=10){let n=e/t,s=(Math.log(n)*Math.LOG10E+1|0)-1;return(n=Math.ceil(n/10**s))%2==1&&n%5>0&&1!==n&&n++,n%6!=0&&n%8!=0||(n=10),n*10**s}function getSteps(e){let t=10,n=getPrettyBreakStep(e,t);for(;n===getPrettyBreakStep(e,t-1);)t--;return{numberOfSteps:t,step:n}}function handleRelative(){const e=document.getElementsByClassName("torelative")[0],t=30*participants.names.length;let n,s,i,a=document.getElementsByClassName("barwrap"),l=(document.querySelectorAll(".x-gr line"),!1),o=participants.maxDuration[stimulus.currentlySelected];const c=getSteps(o);o=participants.maxDuration[stimulus.currentlySelected],e.classList.contains("activebtn3")?(i=getXComponentOfScarf(t,c),document.getElementById("chxlab").innerHTML="Elapsed time [ms]",e.classList.remove("activebtn3")):(l=!0,i=getXComponentOfScarf(t,{numberOfSteps:10,step:10}),document.getElementById("chxlab").innerHTML="Elapsed time [%]",e.classList.add("activebtn3")),o=c.numberOfSteps*c.step;for(var r=0;r<a.length;r++){const e=participants.sessionDuration[stimulus.currentlySelected][r]/o*100;let t=a[r].getElementsByTagName("animate")[0];!0===l?(s=100,n=e):(n=100,s=e),n+="%",s+="%",a[r].setAttribute("width",s),t.setAttribute("from",n),t.setAttribute("to",s),t.beginElement()}document.getElementById("chxcomponent").innerHTML=i}function getXComponentOfScarf(e,t){let n="",s="",i="text-anchor='start'";const a=t.numberOfSteps*t.step;for(var l=0;l<t.numberOfSteps+1;l++){const o=t.step*l;l===t.numberOfSteps&&(i="text-anchor='end'"),n+="<line x1='"+o/a*100+"%' x2='"+o/a*100+"%' y1='0' y2='"+e+"'></line>",s+="<text x='"+o/a*100+"%' "+i+" y='"+(e+14)+"'>"+o+"</text>",i="text-anchor='middle'"}return"<g stroke='#cbcbcb' stroke-width='1'>"+n+"</g><g class='labs'>"+s+"</g>"}function printDataCanvas(){let e=document.getElementById("analysis");const t="<h2 class='anl anim'>Your analysis and visualization</h2><section class='anh'></section><section id='chartsec' class='anh'></section>";e?e.innerHTML=t:((e=document.createElement("section")).id="analysis",e.innerHTML=t,document.getElementsByTagName("main")[0].insertBefore(e,document.getElementById("about")))}function zoomScarf(){const e=document.getElementById("zoomOutScarf"),t=document.getElementById("chareaAni"),n=t.getAttribute("to").slice(0,-1);let s=n;"zoomInScarf"===event.currentTarget.id?s*=2:s/=2,s<100?e.classList.add("deactivated"):(e.classList.remove("deactivated"),t.setAttribute("from",n+"%"),t.setAttribute("to",s+"%"),t.beginElement())}function showDownloadScarfPlotScreen(){let e=document.getElementById("SPdownloadScreen");if(e)e.style.display="";else{let e=document.createElement("div");e.id="SPdownloadScreen",e.classList="exterModal",e.innerHTML='<div class="interModal"><div class="modalHeader">Download Scarf plot<div onclick="closeDownloadScarfPlotScreen()" class="modalClose">X</div></div><div>Width of the plot: <input id="SPwidthInput" type="number" value="800"> px.</div><p style="font-size:.85rem;max-width:300px">It is advised to download the plot as a svg image to ensure its best sharpness.</p><div class="btnholder"><button onclick="getDownloadedScarfPlot()" class="btn">SVG</button><button onclick="getDownloadedScarfPlot()" class="btn2">PNG</button><button class="btn2" onclick="getDownloadedScarfPlot()">JPEG</button><button class="btn2" onclick="getDownloadedScarfPlot()">WEBP</button></div></div>',document.body.appendChild(e)}}function closeDownloadScarfPlotScreen(){document.getElementById("SPdownloadScreen").style.display="none"}function getDownloadedScarfPlot(){let e;const t=document.getElementById("charea");let n=t.getBoundingClientRect().height;const s=document.getElementById("SPwidthInput").value,i=event.target.innerText.toLowerCase();let a=t.cloneNode(!0),l=a.getElementsByTagName("animate");for(;l.length>0;)l[0].remove();const o=function(){const t=document.getElementById("chylabs"),n=t.childNodes,s=t.getBoundingClientRect();e=s.width;let i=document.createElement("g"),a="";for(var l=0;l<n.length;l++){const e=n[l].getBoundingClientRect(),t=e.y+e.height/2-s.y;a+="<text dominant-baseline='middle' y='"+t+"'>"+n[l].innerText+"</text>"}return i.innerHTML=a,i}(),c=function(){const e=document.getElementById("chxlab"),t=e.getBoundingClientRect();let s=document.createElement("g");return s.innerHTML="<text text-anchor='middle' dominant-baseline='middle' x='50%' y='"+(n+t.height/2)+"'>"+e.innerHTML+"</text>",n+=t.height,s}(),r=function(){let e=document.getElementById("chlegend");e.style.width=s+"px";const t=e.childNodes,i=e.getBoundingClientRect();let a="";for(var l=0;l<t.length;l++){const e=t[l].getBoundingClientRect();a+="<rect x='"+(e.x-i.x+10)+"' y='"+(n+(e.y-i.y)+2)+"' fill='"+aoiCategories.colors[l]+"' width='12' height='12'></rect>",a+="<text x='"+(e.x+19-i.x+10)+"' y='"+(n+(e.y-i.y)+12)+"'>"+aoiCategories.names[stimulus.currentlySelected][l]+"</text>"}let o=document.createElement("g");return o.innerHTML=a,n+=i.height,e.style.width="",o}();let d=document.createElement("svg");d.setAttribute("width",s),d.setAttribute("height",n),d.setAttribute("viewBox","0 0 "+s+" "+n),d.setAttribute("xmlns","http://www.w3.org/2000/svg"),a.setAttribute("width",s-e),a.setAttribute("x",e),a.removeAttribute("xmlns"),d.appendChild(a),d.appendChild(o),d.appendChild(c),d.appendChild(r),d.setAttribute("style","font-size:0.85rem");let u=document.createElement("canvas");u.width=s,u.height=n;const m=u.getContext("2d");m.fillStyle="white",m.fillRect(0,0,u.width,u.height);let p=new Image;function g(e,t){let n=document.createElement("a");n.download=t,n.style.opacity="0",document.body.append(n),n.href=e,n.click(),n.remove()}p.src=function(e){let t=new Blob([e.outerHTML],{type:"image/svg+xml;charset=utf-8"});return(window.URL||window.webkitURL||window).createObjectURL(t)}(d),p.onload=function(){"svg"!==i?(m.imageSmoothingEnabled=!1,m.drawImage(p,0,0,s,n),finalImage=u.toDataURL("image/"+i),g(finalImage,"test."+i)):g(p.src,"scarfPlot."+i)}}function handleStimulusChange(e){stimulus.currentlySelected=e.value,document.getElementsByClassName("chartwrap")[0].innerHTML=paintAbsoluteBars()}document.getElementById("file-upload").addEventListener("change",onFileUploadChange,!1),document.getElementById("start-demo").addEventListener("click",startDemo,!1);
